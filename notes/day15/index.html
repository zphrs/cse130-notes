<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Astro description"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/cse130-notes/favicon.svg"><meta name="generator" content="Astro v4.1.2"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preload" href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&family=Comfortaa:wght@700&family=Fira+Code&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&family=Comfortaa:wght@700&family=Fira+Code&display=swap"></noscript><title>Day 15 - Virtualization Cont.</title><style>@keyframes slideInBack{0%{transform:translate(-100%);opacity:0}to{transform:translate(0);opacity:1}}@keyframes slideOutBack{0%{transform:translate(0);opacity:1}to{transform:translate(100%);opacity:0}}@keyframes slideInForward{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}@keyframes slideOutForward{0%{transform:translate(0);opacity:1}to{transform:translate(-100%);opacity:0}}.date[data-astro-cid-v5yihett]{color:var(--gray-60)}.next-prev[data-astro-cid-v5yihett]{display:grid;justify-content:space-between;grid-template-columns:1fr 1fr 1fr;margin:1rem 0;color:var(--gray-60)}.next[data-astro-cid-v5yihett]{text-align:right;grid-column:3 / 4}.prev[data-astro-cid-v5yihett]{grid-column:1 / 2}.all[data-astro-cid-v5yihett]{text-align:center;grid-column:2 / 3}aside[data-astro-cid-v5yihett]{background-color:var(--gray-10);padding:1rem;max-width:800px;margin:0 auto}@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0}}@keyframes astroFadeOut{to{opacity:0}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
</style>
<link rel="stylesheet" href="/cse130-notes/_astro/_slug_.5YG6IZmR.css" /><script type="module" src="/cse130-notes/_astro/hoisted.Ta9NCA9F.js"></script><style>[data-astro-transition-scope="astro-dleqrbkn-1"] { view-transition-name: astro-dleqrbkn-1; }@layer astro { ::view-transition-old(astro-dleqrbkn-1) { 
	animation-duration: 90ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both, both;
	animation-name: astroFadeOut, astroSlideToLeft; }::view-transition-new(astro-dleqrbkn-1) { 
	animation-duration: 210ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-delay: 30ms;
	animation-fill-mode: both, both;
	animation-name: astroFadeIn, astroSlideFromRight; }[data-astro-transition=back]::view-transition-old(astro-dleqrbkn-1) { 
	animation-name: astroFadeOut, astroSlideToRight; }[data-astro-transition=back]::view-transition-new(astro-dleqrbkn-1) { 
	animation-name: astroFadeIn, astroSlideFromLeft; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-dleqrbkn-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-dleqrbkn-1"] { 
	animation-duration: 90ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both, both;
	animation-name: astroFadeOut, astroSlideToLeft; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-dleqrbkn-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-dleqrbkn-1"] { 
	animation-duration: 210ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-delay: 30ms;
	animation-fill-mode: both, both;
	animation-name: astroFadeIn, astroSlideFromRight; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-dleqrbkn-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-dleqrbkn-1"] { 
	animation-name: astroFadeOut, astroSlideToRight; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-dleqrbkn-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-dleqrbkn-1"] { 
	animation-name: astroFadeIn, astroSlideFromLeft; }</style><style>[data-astro-transition-scope="astro-pgxxj7dk-2"] { view-transition-name: astro-pgxxj7dk-2; }@layer astro { ::view-transition-old(astro-pgxxj7dk-2) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideInForward; }::view-transition-new(astro-pgxxj7dk-2) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideOutForward; }[data-astro-transition=back]::view-transition-old(astro-pgxxj7dk-2) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideInBack; }[data-astro-transition=back]::view-transition-new(astro-pgxxj7dk-2) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideOutBack; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-pgxxj7dk-2"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-pgxxj7dk-2"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideInForward; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-pgxxj7dk-2"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-pgxxj7dk-2"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideOutForward; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-pgxxj7dk-2"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-pgxxj7dk-2"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideInBack; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-pgxxj7dk-2"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-pgxxj7dk-2"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideOutBack; }</style><style>[data-astro-transition-scope="astro-jcuwcms7-3"] { view-transition-name: astro-jcuwcms7-3; }@layer astro { ::view-transition-old(astro-jcuwcms7-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(astro-jcuwcms7-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(astro-jcuwcms7-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(astro-jcuwcms7-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-jcuwcms7-3"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-jcuwcms7-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-jcuwcms7-3"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-jcuwcms7-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-jcuwcms7-3"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-jcuwcms7-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-jcuwcms7-3"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-jcuwcms7-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-spzw3xwm-4"] { view-transition-name: astro-spzw3xwm-4; }@layer astro { ::view-transition-old(astro-spzw3xwm-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(astro-spzw3xwm-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(astro-spzw3xwm-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(astro-spzw3xwm-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-spzw3xwm-4"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-spzw3xwm-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-spzw3xwm-4"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-spzw3xwm-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-spzw3xwm-4"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-spzw3xwm-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-spzw3xwm-4"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-spzw3xwm-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-q6rtzicy-5"] { view-transition-name: astro-q6rtzicy-5; }@layer astro { ::view-transition-old(astro-q6rtzicy-5) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideInForward; }::view-transition-new(astro-q6rtzicy-5) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideOutForward; }[data-astro-transition=back]::view-transition-old(astro-q6rtzicy-5) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideInBack; }[data-astro-transition=back]::view-transition-new(astro-q6rtzicy-5) { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideOutBack; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-q6rtzicy-5"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-q6rtzicy-5"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideInForward; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-q6rtzicy-5"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-q6rtzicy-5"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideOutForward; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-q6rtzicy-5"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-q6rtzicy-5"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: backwards;
	animation-name: slideInBack; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-q6rtzicy-5"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-q6rtzicy-5"] { 
	animation-duration: 0.2s;
	animation-timing-function: ease;
	animation-fill-mode: forwards;
	animation-name: slideOutBack; }</style></head> <body>   <aside data-astro-cid-v5yihett data-astro-transition-scope="astro-pgxxj7dk-2"> <span class="date" data-astro-cid-v5yihett data-astro-transition-scope="astro-jcuwcms7-3">February 11, 2024</span> <h1 data-astro-cid-v5yihett data-astro-transition-scope="astro-spzw3xwm-4">Day 15 - Virtualization Cont.</h1> <div class="next-prev" data-astro-cid-v5yihett> <a class="prev" href="../day14/" data-astro-cid-v5yihett>
← prev class
</a> <a class="all" href="/cse130-notes/notes/" data-astro-cid-v5yihett>all notes</a> <a class="next" href="../day16" data-astro-cid-v5yihett>
next class →
</a> </div> </aside> <main data-astro-cid-v5yihett data-astro-transition-scope="astro-q6rtzicy-5">  <h1 id="day-15---virtualization-cont">Day 15 - Virtualization Cont.</h1>
<h2 id="bounded-buffer-example">Bounded Buffer Example</h2>
<pre class="astro-code by https://github.com/el-angel/theme-editor" style="background-color:#E5E6E2;color:#19191A; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#CE9409">#define</span><span style="color:#345348"> N</span><span style="color:#313233"> ...</span><span style="color:#6E9D87"> // buffer size</span></span>
<span class="line"></span>
<span class="line"><span style="color:#313233">Globals:</span></span>
<span class="line"><span style="color:#313233">    Item </span><span style="color:#2D27A4">buffer</span><span style="color:#313233">[N];</span></span>
<span class="line"><span style="color:#CE9409">    int</span><span style="color:#313233"> in </span><span style="color:#CE9409">=</span><span style="color:#413900"> 0</span><span style="color:#313233">, out </span><span style="color:#CE9409">=</span><span style="color:#413900"> 0</span><span style="color:#313233">, counter </span><span style="color:#CE9409">=</span><span style="color:#413900"> 0</span><span style="color:#313233">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9409">void</span><span style="color:#345348"> push</span><span style="color:#313233">(Item </span><span style="color:#2D27A4">item</span><span style="color:#313233">) {</span></span>
<span class="line"><span style="color:#CE9409">    while</span><span style="color:#313233"> (counter </span><span style="color:#CE9409">==</span><span style="color:#313233"> N) {}</span><span style="color:#6E9D87"> // busy waiting</span></span>
<span class="line"><span style="color:#2D27A4">    buffer</span><span style="color:#313233">[in] </span><span style="color:#CE9409">=</span><span style="color:#313233"> item;</span></span>
<span class="line"><span style="color:#313233">    in </span><span style="color:#CE9409">=</span><span style="color:#313233"> (in </span><span style="color:#CE9409">+</span><span style="color:#413900"> 1</span><span style="color:#313233">) </span><span style="color:#CE9409">%</span><span style="color:#313233"> N;</span></span>
<span class="line"><span style="color:#313233">    counter</span><span style="color:#CE9409">++</span><span style="color:#313233">;</span></span>
<span class="line"><span style="color:#313233">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#313233">Item </span><span style="color:#345348">pop</span><span style="color:#313233">() {</span></span>
<span class="line"><span style="color:#CE9409">    while</span><span style="color:#313233"> (counter </span><span style="color:#CE9409">==</span><span style="color:#413900"> 0</span><span style="color:#313233">) {}</span><span style="color:#6E9D87"> // busy waiting</span></span>
<span class="line"><span style="color:#313233">    Item item </span><span style="color:#CE9409">=</span><span style="color:#2D27A4"> buffer</span><span style="color:#313233">[out];</span></span>
<span class="line"><span style="color:#313233">    out </span><span style="color:#CE9409">=</span><span style="color:#313233"> (out </span><span style="color:#CE9409">+</span><span style="color:#413900"> 1</span><span style="color:#313233">) </span><span style="color:#CE9409">%</span><span style="color:#313233"> N;</span></span>
<span class="line"><span style="color:#313233">    counter</span><span style="color:#CE9409">--</span><span style="color:#313233">;</span></span>
<span class="line"><span style="color:#CE9409">    return</span><span style="color:#313233"> item;</span></span>
<span class="line"><span style="color:#313233">}</span></span>
<span class="line"></span></code></pre>
<p>The above code has a race condition.</p>
<h3 id="mutex">Mutex</h3>
<p>One possible fix is with a mutex:</p>
<pre class="astro-code by https://github.com/el-angel/theme-editor" style="background-color:#E5E6E2;color:#19191A; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#313233">Globals:</span></span>
<span class="line"><span style="color:#313233">    Lock l;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9409">void</span><span style="color:#345348"> push</span><span style="color:#313233">(Item </span><span style="color:#2D27A4">item</span><span style="color:#313233">) {</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">acquire</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#CE9409">    while</span><span style="color:#313233"> (counter </span><span style="color:#CE9409">==</span><span style="color:#313233"> N) {</span></span>
<span class="line"><span style="color:#2D27A4">        l</span><span style="color:#313233">.</span><span style="color:#345348">release</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#2D27A4">        l</span><span style="color:#313233">.</span><span style="color:#345348">acquire</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#313233">    }</span><span style="color:#6E9D87"> // busy waiting</span></span>
<span class="line"><span style="color:#2D27A4">    Buffer</span><span style="color:#313233">[in] </span><span style="color:#CE9409">=</span><span style="color:#313233"> item;</span></span>
<span class="line"><span style="color:#313233">    in </span><span style="color:#CE9409">=</span><span style="color:#313233"> (in </span><span style="color:#CE9409">+</span><span style="color:#413900"> 1</span><span style="color:#313233">) </span><span style="color:#CE9409">%</span><span style="color:#313233"> N;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#313233">    counter</span><span style="color:#CE9409">++</span><span style="color:#313233">;</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">release</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#313233">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9409">void</span><span style="color:#345348"> pop</span><span style="color:#313233">() {</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">acquire</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#CE9409">    while</span><span style="color:#313233"> (counter </span><span style="color:#CE9409">==</span><span style="color:#413900"> 0</span><span style="color:#313233">) {</span></span>
<span class="line"><span style="color:#2D27A4">        l</span><span style="color:#313233">.</span><span style="color:#345348">release</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#2D27A4">        l</span><span style="color:#313233">.</span><span style="color:#345348">acquire</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#313233">    }</span><span style="color:#6E9D87"> // busy waiting</span></span>
<span class="line"><span style="color:#313233">    Item item </span><span style="color:#CE9409">=</span><span style="color:#2D27A4"> buffer</span><span style="color:#313233">[out];</span></span>
<span class="line"><span style="color:#313233">    out </span><span style="color:#CE9409">=</span><span style="color:#313233"> (out </span><span style="color:#CE9409">+</span><span style="color:#413900"> 1</span><span style="color:#313233">) </span><span style="color:#CE9409">%</span><span style="color:#313233"> N;</span></span>
<span class="line"><span style="color:#313233">    counter</span><span style="color:#CE9409">--</span><span style="color:#313233">;</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">release</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#CE9409">    return</span><span style="color:#313233"> item;</span></span>
<span class="line"><span style="color:#313233">}</span></span>
<span class="line"></span></code></pre>
<h3 id="condition-variable">Condition Variable</h3>
<p>However, the mutex solution creates needless spin locks. A better solution is to use condition variables:</p>
<pre class="astro-code by https://github.com/el-angel/theme-editor" style="background-color:#E5E6E2;color:#19191A; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#313233">Globals:</span></span>
<span class="line"><span style="color:#313233">    Lock l;</span></span>
<span class="line"><span style="color:#313233">    Condition full, empty;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9409">void</span><span style="color:#345348"> push</span><span style="color:#313233">(Item </span><span style="color:#2D27A4">item</span><span style="color:#313233">) {</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">acquire</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#CE9409">    while</span><span style="color:#313233"> (counter </span><span style="color:#CE9409">==</span><span style="color:#313233"> N) {</span></span>
<span class="line"><span style="color:#2D27A4">        full</span><span style="color:#313233">.</span><span style="color:#345348">wait</span><span style="color:#313233">(l);</span></span>
<span class="line"><span style="color:#313233">    }</span><span style="color:#6E9D87"> // busy waiting</span></span>
<span class="line"><span style="color:#2D27A4">    Buffer</span><span style="color:#313233">[in] </span><span style="color:#CE9409">=</span><span style="color:#313233"> item;</span></span>
<span class="line"><span style="color:#313233">    in </span><span style="color:#CE9409">=</span><span style="color:#313233"> (in </span><span style="color:#CE9409">+</span><span style="color:#413900"> 1</span><span style="color:#313233">) </span><span style="color:#CE9409">%</span><span style="color:#313233"> N;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#313233">    counter</span><span style="color:#CE9409">++</span><span style="color:#313233">;</span></span>
<span class="line"><span style="color:#2D27A4">    empty</span><span style="color:#313233">.</span><span style="color:#345348">signal</span><span style="color:#313233">(l);</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">release</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#313233">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CE9409">void</span><span style="color:#345348"> pop</span><span style="color:#313233">() {</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">acquire</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#CE9409">    while</span><span style="color:#313233"> (counter </span><span style="color:#CE9409">==</span><span style="color:#413900"> 0</span><span style="color:#313233">) {</span></span>
<span class="line"><span style="color:#2D27A4">        empty</span><span style="color:#313233">.</span><span style="color:#345348">wait</span><span style="color:#313233">(l);</span></span>
<span class="line"><span style="color:#313233">    }</span><span style="color:#6E9D87"> // busy waiting</span></span>
<span class="line"><span style="color:#313233">    Item item </span><span style="color:#CE9409">=</span><span style="color:#2D27A4"> buffer</span><span style="color:#313233">[out];</span></span>
<span class="line"><span style="color:#313233">    out </span><span style="color:#CE9409">=</span><span style="color:#313233"> (out </span><span style="color:#CE9409">+</span><span style="color:#413900"> 1</span><span style="color:#313233">) </span><span style="color:#CE9409">%</span><span style="color:#313233"> N;</span></span>
<span class="line"><span style="color:#313233">    counter</span><span style="color:#CE9409">--</span><span style="color:#313233">;</span></span>
<span class="line"><span style="color:#2D27A4">    full</span><span style="color:#313233">.</span><span style="color:#345348">signal</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#2D27A4">    l</span><span style="color:#313233">.</span><span style="color:#345348">release</span><span style="color:#313233">();</span></span>
<span class="line"><span style="color:#CE9409">    return</span><span style="color:#313233"> item;</span></span>
<span class="line"><span style="color:#313233">}</span></span></code></pre>  </main>   </body> </html> 